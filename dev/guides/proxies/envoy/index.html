<!doctype html><html lang=en><head><title>Envoy Integration</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An open source Identity Aware Proxy and an Access Control Decision service for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap px-0" aria-label="Main navigation"><button class="btn btn-outline-dark d-lg-none navbar-toggler border-0 shadow-none ps-3" type=button data-bs-toggle=offcanvas data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu"><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentcolor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5.0 01.5-.5h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 8m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 4"/></svg></button><nav class="offcanvas offcanvas-start d-md-none text-bg-light" tabindex=-1 id=docsMenuContent aria-labelledby=docsMenuContentLabel><div class=offcanvas-header><h5 class=offcanvas-title id=docsMenuContentLabel>Browse docs</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label="Close docs menu"></button></div><div class="offcanvas-body docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a class=active href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li></ul></li></ul></nav></div></nav><div class="d-flex align-items-center px-4"><a class="navbar-brand navbar-brand-highlight text-white me-0" href=../../../ style=font-weight:500;font-size:1.5rem>Heimdall</a><ul class="navbar-nav d-none d-md-flex ms-3"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul></div><div class=d-flex><button type=button class="btn btn-outline-dark navbar-toggler border-0 shadow-none" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<span class="bi bi-search"></span></button>
<button class="btn btn-outline-dark navbar-toggler border-0 shadow-none pe-3" type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentcolor" class="bi bi-three-dots" viewBox="0 0 16 16"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button><div class="offcanvas offcanvas-end text-bg-dark" tabindex=-1 id=mainMenuContent aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h5 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column d-md-none d-lg-none d-xl-none"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white active' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=dev current-page=/guides/proxies/envoy/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
dev</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1 pe-4"><a class="nav-link text-white" style=align-self:center href=https://github.com/dadrus/heimdall><svg xmlns="http://www.w3.org/2000/svg" role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></div></nav></header><div class=modal id=docSearch tabindex=-1 aria-labelledby=docSearchLabel aria-hidden=true><doc-search class="col-auto me-auto mw-75" index-file=/heimdall/dev/index.json path-prefix=/heimdall/dev><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class=modal-content><div class="modal-header p-2"><div class=input-group><div class="input-group-text bg-body border-0 fs-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-search text-secondary my-0" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></div><input id=search-input class="form-control search-bar border-0" type=search placeholder="Search documentation " aria-label="Search docs..." autocomplete=off autofocus><div class="input-group-text bg-body border-0"><a class="btn input-group-text text-muted border p-1 bg-light-subtle fs-7 fw-bold font-monospace" data-bs-dismiss=modal aria-label=Close>ESC</a></div></div></div><div class=modal-body><div class=search-results><p class="text-center mt-5">No recent searches</p></div></div><div class=modal-footer></div></div></div></doc-search></div><div class="container-xxl docs-layout px-4"><aside class="d-none pe-3 docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>API Gateways & Proxies</span><ul><li><a href=../../../guides/proxies/contour/>Contour Integration</a></li><li><a href=../../../guides/proxies/emissary/>Emissary Ingress Integration</a></li><li><a class=active href=../../../guides/proxies/envoy/>Envoy Integration</a></li><li><a href=../../../guides/proxies/haproxy/>HAProxy Integration</a></li><li><a href=../../../guides/proxies/nginx/>NGINX Integration</a></li><li><a href=../../../guides/proxies/traefik/>Traefik Proxy Integration</a></li></ul></li><li><span>Authorization Services</span><ul><li><a href=../../../guides/authz/opa/>Integration with OPA</a></li></ul></li></ul></nav></aside><main class=docs-main><div class="d-md-none docs-location bg-body"><nav style="--bs-breadcrumb-divider:'>'" aria-label=breadcrumb><ol class="breadcrumb mb-0"><li class="breadcrumb-item fw-bold">API Gateways & Proxies</li><li class="breadcrumb-item active" aria-current=page>Envoy Integration</li></ol></nav></div><div class="docs-intro pt-3 pe-3"><h1>Envoy Integration</h1><p>Explains how to integrate heimdall with Envoy, a high performance distributed proxy.</p></div><aside class="text-muted docs-toc"><strong class="d-md-block h6 pb-2 my-2 ms-2 border-bottom d-none d-md-none d-lg-block">On this page</strong><div id=page-content-toc class="mt-1 mb-3 text-muted d-none d-md-none d-lg-block docs-toc-content"><nav id=TableOfContents><ul><li><a href=#_demo_setup>Demo Setup</a></li></ul></nav></div><button class="btn btn-outline-secondary text-decoration-none d-lg-none collapsed" type=button data-bs-toggle=collapse data-bs-target=#page-content-toc-collapsible aria-expanded=false aria-controls=page-content-toc-collapsible>
On this page<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-chevron-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button><div id=page-content-toc-collapsible class="mt-1 mb-3 text-muted d-lg-none collapse docs-toc-content"><div class="card card-body"><nav id=TableOfContents><ul><li><a href=#_demo_setup>Demo Setup</a></li></ul></nav></div></div></aside><div class="docs-content pe-3"><div data-bs-spy=scroll data-bs-target=#page-content-toc class=mt-3><linkable-headline-area><div class=paragraph><p><a href=https://www.envoyproxy.io/>Envoy</a> is a high performance distributed proxy designed for single services and applications, as well as a communication bus and “universal data plane” designed for large microservice “service mesh” architectures. When operating heimdall in <a href=../../../docs/concepts/operating_modes/#_decision_mode>Decision Operation Mode</a>, integration with Envoy can be achieved by making use of an <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> filter. In such setup, Envoy delegates authentication and authorization to heimdall. If heimdall answers with a <code>200 OK</code> HTTP code, Envoy grants access and forwards the original request to the upstream service. Otherwise, the response from heimdall is treated as an error and is returned to the client.</p></div><div class=paragraph><p>To achieve this, configure Envoy</p></div><div class=ulist><ul><li><p>to have heimdall instances referenced in a <code>cluster</code></p><div class=paragraph><p>Following snippet provides an example on how to create a <code>cluster</code> instance referencing heimdall. It assumes, you have just one heimdall instance deployed, which is also available via <code>heimdall</code> DNS name.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>clusters</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#75715e># other cluster entries</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
    <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>strict_dns</span>
    <span style=color:#a6e22e>load_assignment</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
      <span style=color:#a6e22e>endpoints</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>lb_endpoints</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span>
                <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall</span>
                    <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#ae81ff>4456</span>
  <span style=color:#75715e># other cluster entries</span></code></pre></div></div><div class=paragraph><p>If you want to integrate via Envoy’s <code>grpc_service</code> (see below), the cluster entry from above must have <code>http2_protocol_options</code> configured, as otherwise envoy will use HTTP 1 for GRPC communication, which is actually not allowed by GRPC (only HTTP 2 is supported). Here is an updated snipped:</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>clusters</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#75715e># other cluster entries</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
    <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>strict_dns</span>
    <span style=color:#a6e22e>typed_extension_protocol_options</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#a6e22e>envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span>
        <span style=color:#e6db74>explicit_http_config</span><span style=color:#960050>:</span>
          <span style=color:#a6e22e>http2_protocol_options</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>{}</span>
    <span style=color:#a6e22e>load_assignment</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
      <span style=color:#a6e22e>endpoints</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>lb_endpoints</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span>
                <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall</span>
                    <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#ae81ff>4456</span>
  <span style=color:#75715e># other cluster entries</span></code></pre></div></div></li><li><p>to include an <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> HTTP filter in the definition of the HTTP connection manager and depending on the used configuration, either configure the <code>http_service</code> and let it contain the required header name(s), heimdall sets in the HTTP responses (depends on your <a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a> and <a href=../../../docs/mechanisms/finalizers/>Finalizers</a> configuration), or configure the <code>grpc_service</code>.</p><div class=paragraph><p>The following snipped shows, how an <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> can be defined using <code>http_service</code> to let Envoy communicating with heimdall by making use of the previously defined <code>cluster</code> (see snippet from above) as well as forwarding all request headers to heimdall and to let it forward headers, set by heimdall in its responses (here the <code>Authorization</code> header) to the upstream services.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>http_filters</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#75715e># other http filter</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.http.ext_authz</span>
    <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz</span>
      <span style=color:#e6db74>transport_api_version</span><span style=color:#960050>:</span> <span style=color:#e6db74>V3</span>
      <span style=color:#e6db74>http_service</span><span style=color:#960050>:</span>
        <span style=color:#a6e22e>server_uri</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>uri</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall:4456</span>
          <span style=color:#a6e22e>cluster</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
          <span style=color:#a6e22e>timeout</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>0.25s</span>
        <span style=color:#a6e22e>authorization_request</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>allowed_headers</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#a6e22e>patterns</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>safe_regex</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>google_re2</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>{}</span>
                  <span style=color:#a6e22e>regex</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>.*&#34;</span>
        <span style=color:#a6e22e>authorization_response</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>allowed_upstream_headers</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#a6e22e>patterns</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>exact</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>authorization</span>
  <span style=color:#75715e># other http filter</span></code></pre></div></div><div class=paragraph><p>The following snipped shows, how an <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ext_authz/v3/ext_authz.proto.html>External Authorization</a> can be defined using <code>grpc_service</code> to let Envoy communicating with heimdall by making use of the previously defined <code>cluster</code> (see snippet from above). In that configuration envoy by default forwards all request header to heimdall and also forwards headers, set by heimdall in its responses to the upstream services.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>http_filters</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#75715e># other http filter</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.http.ext_authz</span>
    <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz</span>
      <span style=color:#e6db74>transport_api_version</span><span style=color:#960050>:</span> <span style=color:#e6db74>V3</span>
      <span style=color:#e6db74>grpc_service</span><span style=color:#960050>:</span>
        <span style=color:#a6e22e>envoy_grpc</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
  <span style=color:#75715e># other http filter</span></code></pre></div></div></li></ul></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Envoy does not set <code>X-Forwarded-*</code> headers, as long as the <code>envoy.filters.http.dynamic_forward_proxy</code> is not configured. In such cases matching of URLs happens based on those URLs, used by Envoy while communicating with heimdall. That means your rules should ignore the scheme and host parts, respectively use the values specific for heimdall and not of the domain. Please follow <a href=../../../docs/operations/security/#_http_headers_security_considerations>Security Considerations</a> if your rules rely on any of the <code>X-Forwarded-*</code> headers, and you integrate heimdall with envoy using <code>http_service</code>.</p></div><div class=paragraph><p>If you integrate heimdall with envoy via <code>grpc_service</code>, spoofing of the aforesaid headers is not possible.</p></div></td></tr></tbody></table></div><div class=sect1><h2 id=_demo_setup>Demo Setup</h2><div class=sectionbody><div class=paragraph><p>The Envoy configuration file shown below can be used to create a fully working setup based on the quickstart described in <a href=../../../docs/getting_started/protect_an_app/>Protect an Application</a> and set up to implement Edge-level Authorization Architecture. Just update the <code>docker-compose.yaml</code> file used in that guide and replace the entry for <code>proxy</code> service, with the one shown below. You can also remove all <code>labels</code> configurations, as these will have no effect.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#75715e># docker-compose.yaml</span>

<span style=color:#a6e22e>services</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>proxy</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoyproxy/envoy:v1.24.1</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./envoy.yaml:/envoy.yaml:ro</span>
    <span style=color:#a6e22e>ports</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>9090:9090</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>-c /envoy.yaml</span>

  <span style=color:#75715e># other services from the guide</span></code></pre></div></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#75715e># envoy.yaml</span>

<span style=color:#a6e22e>static_resources</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>listeners</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>listener_0</span>
      <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>0.0.0.0</span>
          <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#ae81ff>9090</span>
      <span style=color:#a6e22e>filter_chains</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>filters</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.network.http_connection_manager</span>
            <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
              <span style=color:#e6db74>stat_prefix</span><span style=color:#960050>:</span> <span style=color:#e6db74>edge</span>
              <span style=color:#e6db74>http_filters</span><span style=color:#960050>:</span>
                <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.http.ext_authz</span>
                  <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz</span>
                    <span style=color:#e6db74>transport_api_version</span><span style=color:#960050>:</span> <span style=color:#e6db74>V3</span>
                    <span style=color:#e6db74>http_service</span><span style=color:#960050>:</span>
                      <span style=color:#a6e22e>server_uri</span><span style=color:#fff;background-color:#272822>:</span>
                        <span style=color:#a6e22e>uri</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall:4456</span>
                        <span style=color:#a6e22e>cluster</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
                        <span style=color:#a6e22e>timeout</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>0.25s</span>
                      <span style=color:#a6e22e>authorization_request</span><span style=color:#fff;background-color:#272822>:</span>
                        <span style=color:#a6e22e>allowed_headers</span><span style=color:#fff;background-color:#272822>:</span>
                          <span style=color:#a6e22e>patterns</span><span style=color:#fff;background-color:#272822>:</span>
                            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>safe_regex</span><span style=color:#fff;background-color:#272822>:</span>
                                <span style=color:#a6e22e>google_re2</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>{}</span>
                                <span style=color:#a6e22e>regex</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>.*&#34;</span>
                      <span style=color:#a6e22e>authorization_response</span><span style=color:#fff;background-color:#272822>:</span>
                        <span style=color:#a6e22e>allowed_upstream_headers</span><span style=color:#fff;background-color:#272822>:</span>
                          <span style=color:#a6e22e>patterns</span><span style=color:#fff;background-color:#272822>:</span>
                            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>exact</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>authorization</span>
                <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>envoy.filters.http.router</span>
                  <span style=color:#a6e22e>typed_config</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>@type&#34;</span><span style=color:#960050>:</span> <span style=color:#e6db74>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span>
              <span style=color:#a6e22e>route_config</span><span style=color:#fff;background-color:#272822>:</span>
                <span style=color:#a6e22e>virtual_hosts</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>direct_response_service</span>
                    <span style=color:#a6e22e>domains</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>[</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>*&#34;</span><span style=color:#fff;background-color:#272822>]</span>
                    <span style=color:#a6e22e>routes</span><span style=color:#fff;background-color:#272822>:</span>
                      <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>match</span><span style=color:#fff;background-color:#272822>:</span>
                          <span style=color:#a6e22e>prefix</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/&#34;</span>
                        <span style=color:#a6e22e>route</span><span style=color:#fff;background-color:#272822>:</span>
                          <span style=color:#a6e22e>cluster</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>services</span>

  <span style=color:#a6e22e>clusters</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>strict_dns</span>
      <span style=color:#a6e22e>load_assignment</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>ext-authz</span>
        <span style=color:#a6e22e>endpoints</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>lb_endpoints</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
                      <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>heimdall</span>
                      <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#ae81ff>4456</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>services</span>
      <span style=color:#a6e22e>connect_timeout</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>5s</span>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>strict_dns</span>
      <span style=color:#a6e22e>dns_lookup_family</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>V4_ONLY</span>
      <span style=color:#a6e22e>load_assignment</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>cluster_name</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>services</span>
        <span style=color:#a6e22e>endpoints</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>lb_endpoints</span><span style=color:#fff;background-color:#272822>:</span>
              <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span>
                  <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span>
                    <span style=color:#a6e22e>socket_address</span><span style=color:#fff;background-color:#272822>:</span>
                      <span style=color:#a6e22e>address</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>upstream</span>
                      <span style=color:#a6e22e>port_value</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>80</span></code></pre></div></div><div class=paragraph><p>After starting the docker compose environment, you can run the curl commands shown in the referenced guide. This time however against envoy by using port 9090. E.g. <code>$ curl -v 127.0.0.1:9090/anonymous</code>. By the way, this setup is also available on <a href=https://github.com/dadrus/heimdall/tree/main/examples>GitHub</a>.</p></div></div></div></linkable-headline-area></div><p class="text-end fst-italic fs-7">Last updated on <span class=fw-bold>Mar 9, 2024</span></p><div class="d-flex justify-content-between"><a href=../../../guides/proxies/emissary/><div class="fs-6 mb-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>Emissary Ingress Integration</div></a><a class=ms-auto href=../../../guides/proxies/haproxy/><div class="fs-6 mb-3">HAProxy Integration<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5.0 01.708.0l6 6a.5.5.0 010 .708l-6 6a.5.5.0 01-.708-.708L10.293 8 4.646 2.354a.5.5.0 010-.708z"/></svg></div></a></div></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022-2024 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=mb-2><a href=../../../guides/>Guides</a></li><li class=mb-2><a href=../../../openapi/>API</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../guides/proxies/>API Gateways & Proxies</a></li><li class=mb-2><a href=../../../guides/authz/>Authorization Services</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://discord.gg/qQgg8xKuyb>Discord</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script></body></html>