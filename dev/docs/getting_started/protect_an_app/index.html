<!doctype html><html lang=en><head><title>Protect an Application</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An open source Identity Aware Proxy and an Access Control Decision service for cloud native applications"><meta name=dc.relation content="https://dadrus.github.io/"><meta name=theme-color content="#1A94D2"><link rel=stylesheet href=../../../css/styles.min.css media=screen><link rel='shortcut icon' type=image/x-icon href=../../../favicon.ico></head><body><header class="navbar navbar-expand-md navbar-dark bg-dark sticky-top"><nav class="container-xxl flex-wrap flex-lg-nowrap px-0" aria-label="Main navigation"><button class="btn btn-outline-dark d-lg-none navbar-toggler border-0 shadow-none ps-3" type=button data-bs-toggle=offcanvas data-bs-target=#docsMenuContent aria-controls=docsMenuContent aria-expanded=false aria-label="Open docs menu"><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentcolor" class="bi bi-list" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5.0 01.5-.5h10a.5.5.0 010 1H3a.5.5.0 01-.5-.5m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 8m0-4a.5.5.0 01.5-.5h10a.5.5.0 010 1H3A.5.5.0 012.5 4"/></svg></button><nav class="offcanvas offcanvas-start d-md-none text-bg-light" tabindex=-1 id=docsMenuContent aria-labelledby=docsMenuContentLabel><div class=offcanvas-header><h5 class=offcanvas-title id=docsMenuContentLabel>Browse docs</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label="Close docs menu"></button></div><div class="offcanvas-body docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>Getting Started</span><ul><li><a href=../../../docs/getting_started/discover_heimdall/>Discover heimdall</a></li><li><a href=../../../docs/getting_started/installation/>Install heimdall</a></li><li><a class=active href=../../../docs/getting_started/protect_an_app/>Protect an Application</a></li></ul></li><li><span>Concepts</span><ul><li><a href=../../../docs/concepts/pipelines/>Pipelines</a></li><li><a href=../../../docs/concepts/mechanisms/>Mechanisms</a></li><li><a href=../../../docs/concepts/rules/>Rules</a></li><li><a href=../../../docs/concepts/provider/>Rule Provider</a></li><li><a href=../../../docs/concepts/operating_modes/>Operating Modes</a></li></ul></li><li><span>Operations</span><ul><li><a href=../../../docs/operations/configuration/>Configuration</a></li><li><a href=../../../docs/operations/cli/>CLI</a></li><li><a href=../../../docs/operations/observability/>Observability</a></li><li><a href=../../../docs/operations/cache/>Caching</a></li><li><a href=../../../docs/operations/security/>Security</a></li></ul></li><li><span>Services</span><ul><li><a href=../../../docs/services/decision/>Decision Service</a></li><li><a href=../../../docs/services/proxy/>Proxy Service</a></li><li><a href=../../../docs/services/management/>Management Service</a></li></ul></li><li><span>Mechanisms</span><ul><li><a href=../../../docs/mechanisms/catalogue/>Catalogue</a></li><li><a href=../../../docs/mechanisms/evaluation_objects/>Objects, Templating & Co</a></li><li><a href=../../../docs/mechanisms/authenticators/>Authenticators</a></li><li><a href=../../../docs/mechanisms/authorizers/>Authorizers</a></li><li><a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a></li><li><a href=../../../docs/mechanisms/finalizers/>Finalizers</a></li><li><a href=../../../docs/mechanisms/error_handlers/>Error Handlers</a></li></ul></li><li><span>Rules</span><ul><li><a href=../../../docs/rules/regular_rule/>Regular Rule</a></li><li><a href=../../../docs/rules/default_rule/>Default Rule</a></li><li><a href=../../../docs/rules/rule_sets/>Rule Sets</a></li><li><a href=../../../docs/rules/providers/>Rule Providers</a></li></ul></li><li><span>Configuration Reference</span><ul><li><a href=../../../docs/configuration/types/>Type Definitions</a></li><li><a href=../../../docs/configuration/reference/>Reference</a></li></ul></li></ul></nav></div></nav><div class="d-flex align-items-center px-4"><a class="navbar-brand navbar-brand-highlight text-white me-0" href=../../../ style=font-weight:500;font-size:1.5rem>Heimdall</a><ul class="navbar-nav d-none d-md-flex ms-3"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul></div><div class=d-flex><button type=button class="btn btn-outline-dark navbar-toggler border-0 shadow-none" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search">
<span class="bi bi-search"></span></button>
<button class="btn btn-outline-dark navbar-toggler border-0 shadow-none pe-3" type=button data-bs-toggle=offcanvas data-bs-target=#mainMenuContent aria-controls=mainMenuContent aria-expanded=false aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentcolor" class="bi bi-three-dots" viewBox="0 0 16 16"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button><div class="offcanvas offcanvas-end text-bg-dark" tabindex=-1 id=mainMenuContent aria-labelledby=mainMenuContentLabel><div class=offcanvas-header><h5 class="offcanvas-title text-white" id=mainMenuContentLabel>Heimdall</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class=offcanvas-body><ul class="navbar-nav flex-column d-md-none d-lg-none d-xl-none"><li class=nav-item><a class='nav-link text-white' href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=nav-item><a class='nav-link text-white' href=../../../guides/>Guides</a></li><li class=nav-item><a class='nav-link text-white' href=../../../openapi/>API</a></li></ul><hr class="text-white-50 d-md-none"><ul class="navbar-nav flex-column ms-auto"><doc-version-select class="nav-item dropdown" version-file=/heimdall/data.json current-version=dev current-page=/docs/getting_started/protect_an_app/><button class="btn btn-dark dropdown-toggle me-4" data-bs-toggle=dropdown aria-expanded=false>
dev</button></doc-version-select></ul><ul class="navbar-nav flex-column"><li class="nav-item mb-1 pe-4"><a class="nav-link text-white" style=align-self:center href=https://github.com/dadrus/heimdall><svg xmlns="http://www.w3.org/2000/svg" role="img" width="20" height="20" fill="currentcolor" class="bi bi-github text-white" viewBox="0 0 16 16"><title>GitHub</title><path d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.012 8.012.0 0016 8c0-4.42-3.58-8-8-8z"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></div></nav></header><div class=modal id=docSearch tabindex=-1 aria-labelledby=docSearchLabel aria-hidden=true><doc-search class="col-auto me-auto mw-75" index-file=/heimdall/dev/index.json path-prefix=/heimdall/dev><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class=modal-content><div class="modal-header p-2"><div class=input-group><div class="input-group-text bg-body border-0 fs-4"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-search text-secondary my-0" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></div><input id=search-input class="form-control search-bar border-0" type=search placeholder="Search documentation " aria-label="Search docs..." autocomplete=off autofocus><div class="input-group-text bg-body border-0"><a class="btn input-group-text text-muted border p-1 bg-light-subtle fs-7 fw-bold font-monospace" data-bs-dismiss=modal aria-label=Close>ESC</a></div></div></div><div class=modal-body><div class=search-results><p class="text-center mt-5">No recent searches</p></div></div><div class=modal-footer></div></div></div></doc-search></div><div class="container-xxl docs-layout px-4"><aside class="d-none pe-3 docs-sidebar"><div class=docs-search-button><button type=button class="btn btn-outline-secondary mb-3 d-none d-md-block w-100 text-start" data-bs-toggle=modal data-bs-target=#docSearch aria-controls=docSearch aria-expanded=false aria-label="Open search"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentcolor" class="bi bi-search me-2" viewBox="0 0 20 20"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg>
<span>Quick search...</span></button></div><nav id=SideBarToc><ul><li><span>Getting Started</span><ul><li><a href=../../../docs/getting_started/discover_heimdall/>Discover heimdall</a></li><li><a href=../../../docs/getting_started/installation/>Install heimdall</a></li><li><a class=active href=../../../docs/getting_started/protect_an_app/>Protect an Application</a></li></ul></li><li><span>Concepts</span><ul><li><a href=../../../docs/concepts/pipelines/>Pipelines</a></li><li><a href=../../../docs/concepts/mechanisms/>Mechanisms</a></li><li><a href=../../../docs/concepts/rules/>Rules</a></li><li><a href=../../../docs/concepts/provider/>Rule Provider</a></li><li><a href=../../../docs/concepts/operating_modes/>Operating Modes</a></li></ul></li><li><span>Operations</span><ul><li><a href=../../../docs/operations/configuration/>Configuration</a></li><li><a href=../../../docs/operations/cli/>CLI</a></li><li><a href=../../../docs/operations/observability/>Observability</a></li><li><a href=../../../docs/operations/cache/>Caching</a></li><li><a href=../../../docs/operations/security/>Security</a></li></ul></li><li><span>Services</span><ul><li><a href=../../../docs/services/decision/>Decision Service</a></li><li><a href=../../../docs/services/proxy/>Proxy Service</a></li><li><a href=../../../docs/services/management/>Management Service</a></li></ul></li><li><span>Mechanisms</span><ul><li><a href=../../../docs/mechanisms/catalogue/>Catalogue</a></li><li><a href=../../../docs/mechanisms/evaluation_objects/>Objects, Templating & Co</a></li><li><a href=../../../docs/mechanisms/authenticators/>Authenticators</a></li><li><a href=../../../docs/mechanisms/authorizers/>Authorizers</a></li><li><a href=../../../docs/mechanisms/contextualizers/>Contextualizers</a></li><li><a href=../../../docs/mechanisms/finalizers/>Finalizers</a></li><li><a href=../../../docs/mechanisms/error_handlers/>Error Handlers</a></li></ul></li><li><span>Rules</span><ul><li><a href=../../../docs/rules/regular_rule/>Regular Rule</a></li><li><a href=../../../docs/rules/default_rule/>Default Rule</a></li><li><a href=../../../docs/rules/rule_sets/>Rule Sets</a></li><li><a href=../../../docs/rules/providers/>Rule Providers</a></li></ul></li><li><span>Configuration Reference</span><ul><li><a href=../../../docs/configuration/types/>Type Definitions</a></li><li><a href=../../../docs/configuration/reference/>Reference</a></li></ul></li></ul></nav></aside><main class=docs-main><div class="d-md-none docs-location bg-body"><nav style="--bs-breadcrumb-divider:'>'" aria-label=breadcrumb><ol class="breadcrumb mb-0"><li class="breadcrumb-item fw-bold">Getting Started</li><li class="breadcrumb-item active" aria-current=page>Protect an Application</li></ol></nav></div><div class="docs-intro pt-3 pe-3"><h1>Protect an Application</h1><p>This simple quickstart guide walks you through the steps required to protect an application with heimdall. Here, you'll learn how you can make use of heimdall as an authentication & authorization proxy in front of your application and also how you could implement Edge-level Authorization Architecture (EAA) with heimdall's help.</p></div><aside class="text-muted docs-toc"><strong class="d-md-block h6 pb-2 my-2 ms-2 border-bottom d-none d-md-none d-lg-block">On this page</strong><div id=page-content-toc class="mt-1 mb-3 text-muted d-none d-md-none d-lg-block docs-toc-content"><nav id=TableOfContents><ul><li><a href=#_overview>Overview</a></li><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_configure>Configure</a></li><li><a href=#_start_environment>Start Environment</a></li><li><a href=#_consume_the_api>Consume the API</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div><button class="btn btn-outline-secondary text-decoration-none d-lg-none collapsed" type=button data-bs-toggle=collapse data-bs-target=#page-content-toc-collapsible aria-expanded=false aria-controls=page-content-toc-collapsible>
On this page<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-chevron-expand" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button><div id=page-content-toc-collapsible class="mt-1 mb-3 text-muted d-lg-none collapse docs-toc-content"><div class="card card-body"><nav id=TableOfContents><ul><li><a href=#_overview>Overview</a></li><li><a href=#_prerequisites>Prerequisites</a></li><li><a href=#_configure>Configure</a></li><li><a href=#_start_environment>Start Environment</a></li><li><a href=#_consume_the_api>Consume the API</a></li><li><a href=#_cleanup>Cleanup</a></li></ul></nav></div></div></aside><div class="docs-content pe-3"><div data-bs-spy=scroll data-bs-target=#page-content-toc class=mt-3><linkable-headline-area><div class=sect1><h2 id=_overview>Overview</h2><div class=sectionbody><div class=paragraph><p>In this guide we’re going to configure two setups, both protecting a service which exposes a couple of endpoints:</p></div><div class=ulist><ul><li><p>The <code>/public</code> endpoint is as the name implies public. Every request to it should be forwarded as is.</p></li><li><p>The <code>/user</code> endpoint should only be accessible to users with the role <code>user</code>.</p></li><li><p>The <code>/admin</code> endpoint should only be accessible to users with the role <code>admin</code> and</p></li><li><p>the <code>/private</code> endpoint, as well as any other potentially exposed endpoint should not be accessible at all. So all requests should be rejected.</p></li></ul></div><div class=paragraph><p>For authentication purposes, we’re going to use JWTs, containing the respective role. The authorization will happen with the help of Open Policy Agent (OPA).</p></div><div class=paragraph><p>In both setups, we’re going to create minimal but complete environments using docker compose with</p></div><div class=ulist><ul><li><p><a href=https://doc.traefik.io/traefik/>traefik</a> as an edge proxy,</p></li><li><p><a href=https://hub.docker.com/r/containous/whoami/>containous/whoami</a> (that service just echoes back everything it receives) which mimics our service exposing the abovesaid endpoints,</p></li><li><p>an <a href=https://nginx.org/en/>NGINX</a> server serving the public key for the verification purposes of the JWTs mentioned above (it just mimics the JWKS endpoint typically exposed by an OIDC provider),</p></li><li><p><a href=https://www.openpolicyagent.org/>OPA</a>, which evaluates the above said authorization policy and</p></li><li><p>heimdall, orchestrating everything to implement the above said requirements.</p></li></ul></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>This and similar quickstarts, demonstrating other (integration) options are also available on <a href=https://github.com/dadrus/heimdall/tree/main/examples/docker-compose/quickstarts>GitHub</a>.</td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_prerequisites>Prerequisites</h2><div class=sectionbody><div class=paragraph><p>To be able to follow this guide, you’ll need the following tools installed locally:</p></div><div class=ulist><ul><li><p><a href=https://docs.docker.com/install/>Docker</a>,</p></li><li><p><a href=https://docs.docker.com/compose/install/>docker-compose</a>, and</p></li><li><p>a text editor of your choice.</p></li></ul></div></div></div><div class=sect1><h2 id=_configure>Configure</h2><div class=sectionbody><div class="olist arabic"><ol class=arabic><li><p>Heimdall can be configured via environment variables, as well as using a configuration file. For simplicity reasons, we’ll use a configuration file here. So create a config file named <code>heimdall-config.yaml</code> with the following contents:</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>log</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=1></i><b>(1)</b>
  <span style=color:#a6e22e>level</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>debug</span>

<span style=color:#a6e22e>tracing</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>enabled</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#66d9ef>false</span>

<span style=color:#a6e22e>metrics</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>enabled</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#66d9ef>false</span>

<span style=color:#a6e22e>serve</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=2></i><b>(2)</b>
  <span style=color:#a6e22e>decision</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#a6e22e>trusted_proxies</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>0.0.0.0/0</span>

<span style=color:#a6e22e>mechanisms</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=3></i><b>(3)</b>
  <span style=color:#a6e22e>authenticators</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>id</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>deny_all</span> <i class=conum data-value=4></i><b>(4)</b>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>unauthorized</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>id</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>anon</span> <i class=conum data-value=5></i><b>(5)</b>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>anonymous</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>id</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>jwt_auth</span> <i class=conum data-value=6></i><b>(6)</b>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>jwt</span>
      <span style=color:#a6e22e>config</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>jwks_endpoint</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>http://idp:8080/.well-known/jwks</span>
        <span style=color:#a6e22e>assertions</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#a6e22e>issuers</span><span style=color:#fff;background-color:#272822>:</span>
            <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>demo_issuer</span>
  <span style=color:#a6e22e>authorizers</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>id</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>opa</span> <i class=conum data-value=7></i><b>(7)</b>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>remote</span>
      <span style=color:#a6e22e>config</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>endpoint</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>http://opa:8181/v1/data/{{ .Values.policy }}</span>
        <span style=color:#a6e22e>payload</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}&#34;</span>
        <span style=color:#a6e22e>expressions</span><span style=color:#fff;background-color:#272822>:</span>
          <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>expression</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>|</span>
              <span style=color:#e6db74>Payload.result == true</span>
  <span style=color:#a6e22e>finalizers</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>id</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>create_jwt</span> <i class=conum data-value=8></i><b>(8)</b>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>jwt</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>id</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>noop</span> <i class=conum data-value=9></i><b>(9)</b>
      <span style=color:#a6e22e>type</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>noop</span>

<span style=color:#a6e22e>default_rule</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=10></i><b>(10)</b>
  <span style=color:#a6e22e>methods</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>GET</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>POST</span>
  <span style=color:#a6e22e>execute</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>authenticator</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>deny_all</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>finalizer</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>create_jwt</span>

<span style=color:#a6e22e>providers</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>file_system</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=11></i><b>(11)</b>
    <span style=color:#a6e22e>src</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>/etc/heimdall/rules.yaml</span>
    <span style=color:#a6e22e>watch</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#66d9ef>true</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Since heimdall emits logs on <code>error</code> level by default, and we would like to see what is going on, we are setting the log level to <code>debug</code>. This way, we’ll see not only the results of a particular rule execution (which is what you would see if we set the log level to <code>info</code>), but also what is going in a rule. In addition, we disable tracing and metrics collection as these are pulled by default to an OTEL agent to avoid error statements related to unavailability of the agent. You can find more information about available observability options in the <a href=../../../docs/operations/observability/#_logging>Observability</a> chapter.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>This configuration instructs heimdall to trust <code>X-Forwarded-*</code> headers from any sources. We need it here for integration purposes with Traefik, which uses these headers while forwarding requests to heimdall and which IP depends on your local docker configuration. Never do this in production and use allowed IPs instead! Please take also a look at the documentation of <a href=../../../docs/services/decision/#_trusted_proxies>trusted_proxies</a> property and <a href=../../../docs/operations/security/#_http_header_security_considerations>Security Considerations</a> for more details.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>Here we define our <a href=../../../docs/mechanisms/catalogue/>catalogue of mechanisms</a> to be used in <a href=../../../docs/rules/regular_rule/>upstream service specific rules</a>. In this case we define authenticators, authorizer and finalizers</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>These two lines define the <code><a href=../../../docs/mechanisms/authenticators/#_unauthorized>unauthorized</a></code> authenticator named <code>deny_all</code>. It rejects all requests.</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>These two lines define the <code><a href=../../../docs/mechanisms/authenticators/#_anonymous>anonymous</a></code> authenticator named <code>anon</code>. It allows any request passing through and creates a subject with ID set to <code>anonymous</code>. You can find more information about the subject and other objects <a href=../../../docs/mechanisms/evaluation_objects/#_subject>here</a>.</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>This and the following lines define and configure the <code><a href=../../../docs/mechanisms/authenticators/#_jwt>jwt</a></code> authenticator named <code>jwt_auth</code>. With the given configuration it will check whether a request contains an <code>Authorization</code> header with a bearer token in JWT format and validate it using key material fetched from the JWKS endpoint. It will reject all requests without a valid JWT or create a subject with ID set to the value of the <code>sub</code> claim from the token and add also add all claims as key-value map to subject’s Attribute property.</td></tr><tr><td><i class=conum data-value=7></i><b>7</b></td><td>Here we define and configure a <code><a href=../../../docs/mechanisms/authorizers/#_remote>remote</a></code> authorizer named <code>opa</code>. Please note, how we allow overriding of particular settings, which application you’ll find below, when we define the rules.</td></tr><tr><td><i class=conum data-value=8></i><b>8</b></td><td>The following two lines define the <code><a href=../../../docs/mechanisms/finalizers/#_jwt>jwt</a></code> finalizer. Without any configuration, as used here, it will create a jwt out of the subject object with standard claims and set the <code>sub</code> claim to the value of subject’s ID. The key material used for signature creation purpose will be generated on start up. This is fine for our demo purpose. For real scenarios you should definitely <a href=../../../docs/operations/security/#_signatures>define it</a>.</td></tr><tr><td><i class=conum data-value=9></i><b>9</b></td><td>These two lines conclude the definition of our mechanisms catalogue and define the <code><a href=../../../docs/mechanisms/finalizers/#_noop>noop</a></code> finalizer, which as the type implies, does nothing.</td></tr><tr><td><i class=conum data-value=10></i><b>10</b></td><td>With the above catalogue in place, we can now define a <a href=../../../docs/rules/default_rule/>default rule</a>, which will kick in if no other rule matches the request. In addition, it acts as a <a href=../../../docs/concepts/rules/#_default_rule_inheritance>base</a> for the definition of regular (upstream service specific) rules. In this case it allows only HTTP GET and POST requests and defines a secure default <a href=../../../docs/concepts/pipelines/#_authentication_authorization_pipeline>authentication & authorization pipeline</a>, which refuses any request by making use of the <code>deny_all</code> authenticator, and if the regular rule overrides that authenticator, will create a JWT thanks to the used <code>jwt</code> finalizer.</td></tr><tr><td><i class=conum data-value=11></i><b>11</b></td><td>The last few lines of the configure the <a href=../../../docs/rules/providers/#_filesystem><code>file_system</code></a> provider, which allows loading of regular rules from the file system. Btw. the provider is configured to watch for changes. So you can modify the rules, we’re going to create, while playing around.</td></tr></tbody></table></div></li><li><p>Now, create a rule file named <code>upstream-rules.yaml</code>, which will implement the authentication and authorization requirements of our service, and copy the following contents to it:</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>version</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>1alpha3&#34;</span>
<span style=color:#a6e22e>rules</span><span style=color:#fff;background-color:#272822>:</span>
<span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>id</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>demo:public</span>  <i class=conum data-value=1></i><b>(1)</b>
  <span style=color:#a6e22e>match</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#a6e22e>url</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>http://&lt;**&gt;/public</span>
  <span style=color:#a6e22e>forward_to</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#a6e22e>host</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>upstream:8081</span>
  <span style=color:#a6e22e>execute</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>authenticator</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>anon</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>finalizer</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>noop</span>

<span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>id</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>demo:protected</span>  <i class=conum data-value=2></i><b>(2)</b>
  <span style=color:#a6e22e>match</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#a6e22e>url</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>http://&lt;**&gt;/&lt;{user,admin}&gt;</span>
  <span style=color:#a6e22e>forward_to</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#a6e22e>host</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>upstream:8081</span>
  <span style=color:#a6e22e>execute</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>authenticator</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>jwt_auth</span>
  <span style=color:#fff;background-color:#272822>-</span> <span style=color:#a6e22e>authorizer</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>opa</span>
    <span style=color:#a6e22e>config</span><span style=color:#fff;background-color:#272822>:</span>
      <span style=color:#a6e22e>values</span><span style=color:#fff;background-color:#272822>:</span>
        <span style=color:#a6e22e>policy</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>demo/can_access</span>
      <span style=color:#a6e22e>payload</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>|</span>
        <span style=color:#e6db74>{</span>
          <span style=color:#e6db74>&#34;input&#34;: {</span>
            <span style=color:#e6db74>&#34;role&#34;: {{ quote .Subject.Attributes.role }},</span>
            <span style=color:#e6db74>&#34;path&#34;: {{ quote .Request.URL.Path }}</span>
          <span style=color:#e6db74>}</span>
        <span style=color:#e6db74>}</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>This rule matches our <code>/public</code> endpoint and forwards the request to our upstream service. It doesn’t perform any kind of request verification or transformation.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>This rule matches the <code>/user</code> and the <code>/admin</code> endpoints and performs the required authentication as well as authorization steps.<div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content>Please note, that we don’t define any finalizer in the pipeline of the second rule. Since we have a default rule with a finalizer configured, it is reused here. There is no need for other rules as well as our default rule will block requests to any other endpoints.</td></tr></tbody></table></div></td></tr></tbody></table></div></li><li><p>Having everything related to heimdall configuration, let us now create a policy, OPA is going to use. So, create a file named <code>policy.rego</code> with the following contents.</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=rego><span style=color:#f92672>package</span> <span style=color:#fff;background-color:#272822>demo</span>

<span style=color:#f92672>default</span> <span style=color:#fff;background-color:#272822>can_access</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <i class=conum data-value=1></i><b>(1)</b>

<span style=color:#fff;background-color:#272822>can_access</span> <span style=color:#fff;background-color:#272822>{</span> <span style=color:#fff;background-color:#272822>split</span><span style=color:#fff;background-color:#272822>(</span><span style=color:#fff;background-color:#272822>input</span><span style=color:#fff;background-color:#272822>.</span><span style=color:#fff;background-color:#272822>path</span><span style=color:#fff;background-color:#272822>,</span> <span style=color:#e6db74>&#34;/&#34;</span><span style=color:#fff;background-color:#272822>)[</span><span style=color:#ae81ff>1</span><span style=color:#fff;background-color:#272822>]</span> <span style=color:#f92672>==</span> <span style=color:#fff;background-color:#272822>input</span><span style=color:#fff;background-color:#272822>.</span><span style=color:#fff;background-color:#272822>role</span> <span style=color:#fff;background-color:#272822>}</span> <i class=conum data-value=2></i><b>(2)</b></code></pre></div></div><div class=paragraph><p>Here, we say, our policy <code>can_access</code> is located in the <code>demo</code> package. The policy itself is pretty simple and evaluates only to true or false.</p></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>Per default, the <code>can_access</code> policy evaluates to false.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>And it evaluates only to true, if the last path fragment of the request is equal to the user’s role.</td></tr></tbody></table></div></li><li><p>Let us now configure NGINX to expose a static endpoint serving a JWKS document under the <code>.well-known</code> path, so heimdall is able to verify the JWTs, we’re going to use. Create a file named <code>idp.nginx</code> with the following content:</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash>worker_processes  1<span style=color:#fff;background-color:#272822>;</span>
user       nginx<span style=color:#fff;background-color:#272822>;</span>
pid        /var/run/nginx.pid<span style=color:#fff;background-color:#272822>;</span>

events <span style=color:#f92672>{</span>
  worker_connections  1024<span style=color:#fff;background-color:#272822>;</span>
<span style=color:#f92672>}</span>

http <span style=color:#f92672>{</span>
    keepalive_timeout  65<span style=color:#fff;background-color:#272822>;</span>

    server <span style=color:#f92672>{</span>
        listen 8080<span style=color:#fff;background-color:#272822>;</span>

        location /.well-known/jwks <span style=color:#f92672>{</span>
            default_type  application/json<span style=color:#fff;background-color:#272822>;</span>
            root /var/www/nginx<span style=color:#fff;background-color:#272822>;</span>
            try_files /jwks.json <span style=color:#f92672>=</span>404<span style=color:#fff;background-color:#272822>;</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span></code></pre></div></div><div class=paragraph><p>In addition, create a file named <code>jwks.json</code> with the public key required to verify the tokens we’re going to use.</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=json><span style=color:#fff;background-color:#272822>{</span><span style=color:#fff;background-color:#272822>
  </span><span style=color:#fff;background-color:#272822>&#34;keys&#34;</span><span style=color:#fff;background-color:#272822>:</span><span style=color:#fff;background-color:#272822> </span><span style=color:#fff;background-color:#272822>[{</span><span style=color:#fff;background-color:#272822>
    </span><span style=color:#fff;background-color:#272822>&#34;use&#34;</span><span style=color:#fff;background-color:#272822>:</span><span style=color:#e6db74>&#34;sig&#34;</span><span style=color:#fff;background-color:#272822>,</span><span style=color:#fff;background-color:#272822>
    </span><span style=color:#fff;background-color:#272822>&#34;kty&#34;</span><span style=color:#fff;background-color:#272822>:</span><span style=color:#e6db74>&#34;EC&#34;</span><span style=color:#fff;background-color:#272822>,</span><span style=color:#fff;background-color:#272822>
    </span><span style=color:#fff;background-color:#272822>&#34;kid&#34;</span><span style=color:#fff;background-color:#272822>:</span><span style=color:#e6db74>&#34;key-1&#34;</span><span style=color:#fff;background-color:#272822>,</span><span style=color:#fff;background-color:#272822>
    </span><span style=color:#fff;background-color:#272822>&#34;crv&#34;</span><span style=color:#fff;background-color:#272822>:</span><span style=color:#e6db74>&#34;P-256&#34;</span><span style=color:#fff;background-color:#272822>,</span><span style=color:#fff;background-color:#272822>
    </span><span style=color:#fff;background-color:#272822>&#34;alg&#34;</span><span style=color:#fff;background-color:#272822>:</span><span style=color:#e6db74>&#34;ES256&#34;</span><span style=color:#fff;background-color:#272822>,</span><span style=color:#fff;background-color:#272822>
    </span><span style=color:#fff;background-color:#272822>&#34;x&#34;</span><span style=color:#fff;background-color:#272822>:</span><span style=color:#e6db74>&#34;cv6F6SgBSNWMZKdApZXSuPD6QPtvQyMpk-iRfZxT-vo&#34;</span><span style=color:#fff;background-color:#272822>,</span><span style=color:#fff;background-color:#272822>
    </span><span style=color:#fff;background-color:#272822>&#34;y&#34;</span><span style=color:#fff;background-color:#272822>:</span><span style=color:#e6db74>&#34;C1r3OClUvyDgmDQdvxMdB-ucmZ28b8s4uM4Yg-0BZZ4&#34;</span><span style=color:#fff;background-color:#272822>
  </span><span style=color:#fff;background-color:#272822>}]</span><span style=color:#fff;background-color:#272822>
</span><span style=color:#fff;background-color:#272822>}</span></code></pre></div></div><div class=paragraph><p>We will add it to the above referenced <code>/var/www/nginx</code> folder, when we define our setup environments.</p></div></li><li><p>Time to configure the environment to play with. If you want to run <strong>heimdall as proxy</strong>, create or copy the following <code>docker-compose.yaml</code> file and modify it to include the correct paths to your <code>heimdall-config.yaml</code>, <code>upstream-rules.yaml</code>, <code>policy.rego</code>, <code>idp.nginx</code> and the <code>jwks.json</code> files from above:</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>version</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#39;</span><span style=color:#e6db74>3.7&#39;</span>

<span style=color:#a6e22e>services</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>heimdall</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=1></i><b>(1)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>dadrus/heimdall:latest</span>
    <span style=color:#a6e22e>ports</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>9090:4455&#34;</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./heimdall-config.yaml:/etc/heimdall/config.yaml:ro</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./upstream-rules.yaml:/etc/heimdall/rules.yaml:ro</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>-c /etc/heimdall/config.yaml serve proxy</span>

  <span style=color:#a6e22e>upstream</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=2></i><b>(2)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>containous/whoami:latest</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>--port=8081</span>

  <span style=color:#a6e22e>idp</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=3></i><b>(3)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>nginx:1.25.4</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./idp.nginx:/etc/nginx/nginx.conf:ro</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./jwks.json:/var/www/nginx/jwks.json:ro</span>

  <span style=color:#a6e22e>opa</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=4></i><b>(4)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>openpolicyagent/opa:0.62.1</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>run --server /etc/opa/policies</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./policy.rego:/etc/opa/policies/policy.rego:ro</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>These lines configure heimdall to use our config and rule file and to run in proxy operation mode.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Here, we configure the "upstream" service. As already written above, it is a very simple service, which just echoes back everything it receives.</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>This is our NGINX, which mimics an IDP system and exposes an JWKS endpoint with our key material.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>And these lines configure our OPA instance to use our authorization policy</td></tr></tbody></table></div></li><li><p>Alternatively, if you would like to implement <strong>EAA with heimdall</strong>, create or copy the following <code>docker-compose-eaa.yaml</code> file and modify it to include the correct paths to the <code>heimdall-config.yaml</code>, <code>upstream-rules.yaml</code>, <code>policy.rego</code>, <code>idp.nginx</code> and the <code>jwks.json</code> files from above as well:</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=yaml><span style=color:#a6e22e>version</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>3&#34;</span>

<span style=color:#a6e22e>services</span><span style=color:#fff;background-color:#272822>:</span>
  <span style=color:#a6e22e>proxy</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=1></i><b>(1)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>traefik:2.11.0</span>
    <span style=color:#a6e22e>ports</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>9090:9090&#34;</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#fff;background-color:#272822>&gt;</span>
      <span style=color:#e6db74>--providers.docker=true</span>
      <span style=color:#e6db74>--providers.docker.exposedbydefault=false</span>
      <span style=color:#e6db74>--entryPoints.http.address=&#34;:9090&#34;</span>
      <span style=color:#e6db74>--accesslog --api=true --api.insecure=true</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/var/run/docker.sock:/var/run/docker.sock:ro&#34;</span>
    <span style=color:#a6e22e>labels</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.enable=true</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.http.routers.traefik_http.service=api@internal</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.http.routers.traefik_http.entrypoints=http</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.http.middlewares.heimdall.forwardauth.address=http://heimdall:4456</span>  <i class=conum data-value=2></i><b>(2)</b>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.http.middlewares.heimdall.forwardauth.authResponseHeaders=Authorization</span>

  <span style=color:#a6e22e>heimdall</span><span style=color:#fff;background-color:#272822>:</span>  <i class=conum data-value=3></i><b>(3)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>dadrus/heimdall:latest</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./heimdall-config.yaml:/etc/heimdall/config.yaml:ro</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./upstream-rules.yaml:/etc/heimdall/rules.yaml:ro</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>-c /etc/heimdall/config.yaml serve decision</span>

  <span style=color:#a6e22e>upstream</span><span style=color:#fff;background-color:#272822>:</span>  <i class=conum data-value=4></i><b>(4)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>containous/whoami:latest</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>--port=8081</span>
    <span style=color:#a6e22e>labels</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.enable=true</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.http.services.whoami.loadbalancer.server.port=8081</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.http.routers.whoami.rule=PathPrefix(&#34;/&#34;)</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>traefik.http.routers.whoami.middlewares=heimdall</span>

  <span style=color:#a6e22e>idp</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=5></i><b>(5)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>nginx:1.25.4</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./idp.nginx:/etc/nginx/nginx.conf:ro</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./jwks.json:/var/www/nginx/jwks.json:ro</span>

  <span style=color:#a6e22e>opa</span><span style=color:#fff;background-color:#272822>:</span> <i class=conum data-value=6></i><b>(6)</b>
    <span style=color:#a6e22e>image</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>openpolicyagent/opa:0.62.1</span>
    <span style=color:#a6e22e>command</span><span style=color:#fff;background-color:#272822>:</span> <span style=color:#e6db74>run --server /etc/opa/policies</span>
    <span style=color:#a6e22e>volumes</span><span style=color:#fff;background-color:#272822>:</span>
    <span style=color:#fff;background-color:#272822>-</span> <span style=color:#e6db74>./policy.rego:/etc/opa/policies/policy.rego:ro</span></code></pre></div></div><div class="colist arabic"><table><tbody><tr><td><i class=conum data-value=1></i><b>1</b></td><td>These lines configure Traefik, which is used to dispatch the incoming requests and also forward all of them to heimdall before routing to the target service. We’re using the ForwardAuth middleware here, which requires an additional configuration on the route level.</td></tr><tr><td><i class=conum data-value=2></i><b>2</b></td><td>Here we configure Trafik to forward the requests to heimdall</td></tr><tr><td><i class=conum data-value=3></i><b>3</b></td><td>These lines configure heimdall to use our config and rule file and to run in decision operation mode.</td></tr><tr><td><i class=conum data-value=4></i><b>4</b></td><td>Here, we configure the "upstream" service. As already written above, it is a very simple service, which just echoes back everything it receives. As also written above, we need to provide some route level configuration here to have the requests forwarded to heimdall. We could however also have a global configuration (which we decided not to do to avoid yet another configuration file).</td></tr><tr><td><i class=conum data-value=5></i><b>5</b></td><td>This is our NGINX, which mimics an IDP system and exposes an JWKS endpoint with our key material.</td></tr><tr><td><i class=conum data-value=6></i><b>6</b></td><td>And these lines configure our OPA instance to use our authorization policy</td></tr></tbody></table></div></li></ol></div></div></div><div class=sect1><h2 id=_start_environment>Start Environment</h2><div class=sectionbody><div class=paragraph><p>Open your terminal and start the services in the directory, the above <code>docker-compose.yaml</code> file is located in with</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash><span style=color:#fff;background-color:#272822>$ </span>docker-compose up</code></pre></div></div></div></div><div class=sect1><h2 id=_consume_the_api>Consume the API</h2><div class=sectionbody><div class=paragraph><p>Roll up your sleeves. We’re going to play with our setup now. Open a new terminal window and put it nearby the terminal, you started the environment in. This way you’ll see what is going on in the environment when you use it.</p></div><div class="olist arabic"><ol class=arabic><li><p>Let’s try the <code>/public</code> endpoint first</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash><span style=color:#fff;background-color:#272822>$ </span>curl 127.0.0.1:9090/public</code></pre></div></div><div class=paragraph><p>You should see an output similar to the one shown below</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash>Hostname: 94e60bba8498
IP: 127.0.0.1
IP: 172.19.0.3
RemoteAddr: 172.19.0.4:53980
GET /public HTTP/1.1
Host: upstream:8081
User-Agent: curl/8.2.1
Accept: <span style=color:#f92672>*</span>/<span style=color:#f92672>*</span>
Accept-Encoding: <span style=color:#f6aa11>gzip
</span>Forwarded: <span style=color:#f92672>for</span><span style=color:#f92672>=</span>172.19.0.1<span style=color:#fff;background-color:#272822>;</span><span style=color:#fff;background-color:#272822>host</span><span style=color:#f92672>=</span>127.0.0.1:9090<span style=color:#fff;background-color:#272822>;</span><span style=color:#fff;background-color:#272822>proto</span><span style=color:#f92672>=</span>http</code></pre></div></div><div class=paragraph><p>That was obviously expected as we’ve sent a request to our public endpoint.</p></div></li><li><p>Let’s try some other endpoints:</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash><span style=color:#fff;background-color:#272822>$ </span>curl <span style=color:#f92672>-v</span> 127.0.0.1:9090/admin</code></pre></div></div><div class=paragraph><p>The <code>-v</code> flag has be added to the curl command by intention. Without it, we’ll not see any output. With it, we’ll see the response shown below</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash><span style=color:#f92672>*</span> processing: 127.0.0.1:9090/admin
<span style=color:#f92672>*</span>   Trying 127.0.0.1:9090...
<span style=color:#f92672>*</span> Connected to 127.0.0.1 <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> port 9090
<span style=color:#f92672>&gt;</span> GET /admin HTTP/1.1
<span style=color:#f92672>&gt;</span> Host: 127.0.0.1:9090
<span style=color:#f92672>&gt;</span> User-Agent: curl/8.2.1
<span style=color:#f92672>&gt;</span> Accept: <span style=color:#f92672>*</span>/<span style=color:#f92672>*</span>
<span style=color:#f92672>&gt;</span>
&lt; HTTP/1.1 401 Unauthorized
&lt; Date: Wed, 06 Mar 2024 16:14:05 GMT
&lt; Content-Length: 0
&lt;
<span style=color:#f92672>*</span> Connection <span style=color:#75715e>#0 to host 127.0.0.1 left intact</span></code></pre></div></div><div class=paragraph><p>That is, unauthorized. Requests to any other endpoint, but <code>/public</code> will result in the same output.</p></div></li><li><p>Let us now use a proper JWT, which will allow us to send requests to either the <code>/admin</code> or the <code>/user</code> endpoint. Below, you’ll find a new request using curl to our <code>/admin</code> endpoint again. This time however, it contains an <code>Authorization</code> header with a bearer token in it which should allow us getting access. Try it out.</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash><span style=color:#fff;background-color:#272822>$ </span>curl <span style=color:#f92672>-H</span> <span style=color:#e6db74>&#34;Authorization: Bearer eyJhbGciOiJFUzI1NiIsImtpZCI6ImtleS0xIiwidHlwIjoiSldUIn0.eyJleHAiOjIwMjUxMDA3NTEsImlhdCI6MTcwOTc0MDc1MSwiaXNzIjoiZGVtb19pc3N1ZXIiLCJqdGkiOiI0NjExZDM5Yy00MzI1LTRhMWYtYjdkOC1iMmYxMTE3NDEyYzAiLCJuYmYiOjE3MDk3NDA3NTEsInJvbGUiOiJhZG1pbiIsInN1YiI6IjEifQ.mZZ_UqC8RVzEKBPZbPs4eP-MkXLK22Q27ZJ34UwJiioFdaYXqYJ4ZsatP0TbpKeNyF83mkrrCGL_pWLFTho7Gg&#34;</span> 127.0.0.1:9090/admin</code></pre></div></div><div class=paragraph><p>We can now access the endpoint and see the following output</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash>Hostname: 94e60bba8498
IP: 127.0.0.1
IP: 172.19.0.2
RemoteAddr: 172.19.0.4:43688
GET /admin HTTP/1.1
Host: upstream:8081
User-Agent: curl/8.2.1
Accept: <span style=color:#f92672>*</span>/<span style=color:#f92672>*</span>
Accept-Encoding: <span style=color:#f6aa11>gzip
</span>Authorization: Bearer eyJhbGciOiJFUzM4NCIsImtpZCI6IjEzNTQxODg3NGFiNzQwN2I3ZWQ0MmU5MmM4NWIzY2ZkNDJmZDk5NDgiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3MDk3NDI2NzYsImlhdCI6MTcwOTc0MjM3NiwiaXNzIjoiaGVpbWRhbGwiLCJqdGkiOiJhYTZkZDE1MC0yMzhiLTQ2YWEtOTIzMi00MDRjMWNiMGM4ZDMiLCJuYmYiOjE3MDk3NDIzNzYsInN1YiI6IjEifQ.84QF4F7-WKSAV4KcC2Z_7SG4VkiEXg0fUu1hLS-zKR8-SfpM3XVphLz3QVg4aDXe4AxiNIfqyA5rE9ZEFnYAlFfWOIt2R7i0PZh2gf1PBOQMj6cMLbDSUw_YZ9x1XWcf
Forwarded: <span style=color:#f92672>for</span><span style=color:#f92672>=</span>172.19.0.1<span style=color:#fff;background-color:#272822>;</span><span style=color:#fff;background-color:#272822>host</span><span style=color:#f92672>=</span>127.0.0.1:9090<span style=color:#fff;background-color:#272822>;</span><span style=color:#fff;background-color:#272822>proto</span><span style=color:#f92672>=</span>http</code></pre></div></div><div class=paragraph><p>Take a closer look at the JWT echoed by our service, e.g. by making use of <a href=https://jwt.io class=bare>https://jwt.io</a>. It has been issued by heimdall and is not the token you’ve sent using curl.</p></div></li><li><p>Guess what would happen, when we try the same request, but to the <code>/user</code> endpoint? You’re right, it will be refused due to the wrong role. Let us then use another JWT. Try the request shown below. It contains a token which should give us access.</p><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash><span style=color:#fff;background-color:#272822>$ </span>curl <span style=color:#f92672>-H</span> <span style=color:#e6db74>&#34;Authorization: Bearer eyJhbGciOiJFUzI1NiIsImtpZCI6ImtleS0xIiwidHlwIjoiSldUIn0.eyJleHAiOjIwMjUxMDA3NTEsImlhdCI6MTcwOTc0MDc1MSwiaXNzIjoiZGVtb19pc3N1ZXIiLCJqdGkiOiIzZmFmNDkxOS0wZjUwLTQ3NGItOGExMy0yOTYzMjEzNThlOTMiLCJuYmYiOjE3MDk3NDA3NTEsInJvbGUiOiJ1c2VyIiwic3ViIjoiMiJ9.W5xCpwsFShS0RpOtrm9vrV2dN6K8pRr5gQnt0kluzLE6oNWFzf7Oot-0YLCPa64Z3XPd7cfGcBiSjrzKZSAj4g&#34;</span> 127.0.0.1:9090/user</code></pre></div></div><div class=paragraph><p>Was successful, right? We omitted the output for brevity reasons. This guide is already long enough.</p></div></li><li><p>Try to send requests to the <code>/private</code> endpoint using any of the tokens from above. Yep. Useless. Heimdall will not let us through.</p></li></ol></div></div></div><div class=sect1><h2 id=_cleanup>Cleanup</h2><div class=sectionbody><div class=paragraph><p>Just stop the environment with <code>CTRL-C</code> and delete the created files. If you started docker compose in the background, tear the environment down with</p></div><div class=listingblock><div class=content><pre class="rouge highlight" style=color:#fff;background-color:#272822><code data-lang=bash><span style=color:#fff;background-color:#272822>$ </span>docker-compose down</code></pre></div></div></div></div></linkable-headline-area></div><p class="text-end fst-italic fs-7">Last updated on <span class=fw-bold>Mar 9, 2024</span></p><div class="d-flex justify-content-between"><a href=../../../docs/getting_started/installation/><div class="fs-6 mb-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-chevron-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5.0 010 .708L5.707 8l5.647 5.646a.5.5.0 01-.708.708l-6-6a.5.5.0 010-.708l6-6a.5.5.0 01.708.0z"/></svg>Install heimdall</div></a><a class=ms-auto href=../../../docs/concepts/pipelines/><div class="fs-6 mb-3">Pipelines<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5.0 01.708.0l6 6a.5.5.0 010 .708l-6 6a.5.5.0 01-.708-.708L10.293 8 4.646 2.354a.5.5.0 010-.708z"/></svg></div></a></div></div></main></div><footer class="footer py-4 py-md-5 px-4 px-md-3"><div class=container><div class=row><div class="col-lg-3 mb-3"><p class=fs-5>Heimdall</p><ul class="list-unstyled small text-muted"><li class=mb-2>2022-2024 © Heimdall Project Authors. All rights reserved.</li><li class=mb-2><a href=https://github.com/dadrus/heimdall/blob/master/LICENSE>Apache 2.0 licensed</a></li></ul></div><div class="col-6 col-lg-2 offset-lg-1 mb-3"><h5>Links</h5><ul class=list-unstyled><li class=mb-2><a href=../../../>Home</a></li><li class=mb-2><a href=../../../docs/getting_started/discover_heimdall>Docs</a></li><li class=mb-2><a href=../../../guides/>Guides</a></li><li class=mb-2><a href=../../../openapi/>API</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Guides</h5><ul class=list-unstyled><li class=mb-2><a href=../../../guides/proxies/>API Gateways & Proxies</a></li><li class=mb-2><a href=../../../guides/authz/>Authorization Services</a></li></ul></div><div class="col-6 col-lg-2 mb-2"><h5>Community</h5><ul class=list-unstyled><li class=mb-2><a href=https://github.com/dadrus/heimdall>Github</a></li><li class=mb-2><a href=https://discord.gg/qQgg8xKuyb>Discord</a></li></ul></div></div></div></footer><script src=../../../js/main.js defer></script></body></html>